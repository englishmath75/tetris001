<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Tetris Game - Integrated</title>
    
    <style>
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ ë° ëª¨ë°”ì¼ ìµœì í™” */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; 
            margin: 0;
            background-color: #222;
            color: white;
            font-family: sans-serif;
            user-select: none; /* ëª¨ë°”ì¼ í„°ì¹˜ ì‹œ ì„ íƒ ë°©ì§€ */
        }

        #game-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        #info-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* ê²Œì„ ë³´ë“œ ìŠ¤íƒ€ì¼ */
        #game-board {
            display: grid;
            grid-template-rows: repeat(20, 1fr); 
            grid-template-columns: repeat(10, 1fr);
            width: 250px; /* 10ì¹¸ * 25px */
            height: 500px; /* 20ì¹¸ * 25px */
            border: 5px solid #555;
            background-color: #000;
        }

        /* ê° ì¹¸(ì…€) ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .cell {
            box-sizing: border-box;
            border: 1px solid #111; 
        }

        /* ğŸ§± ë¸”ë¡ ìƒ‰ìƒ ì •ì˜ (CSS í´ë˜ìŠ¤) */
        .I { background-color: cyan; border: 2px solid lightblue; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .J { background-color: blue; border: 2px solid lightblue; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .L { background-color: orange; border: 2px solid lightsalmon; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .O { background-color: yellow; border: 2px solid lightyellow; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .S { background-color: green; border: 2px solid lightgreen; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .T { background-color: purple; border: 2px solid plum; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .Z { background-color: red; border: 2px solid lightcoral; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}

        /* ë¸”ë¡ì´ ê³ ì •ëœ ìƒíƒœ (Taken) */
        .taken {
            opacity: 0.8; 
        }

        /* ğŸ“± ëª¨ë°”ì¼ ì¡°ì‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 300px; 
        }

        .control-btn {
            width: 80px;
            height: 80px;
            font-size: 30px;
            margin: 5px;
            border-radius: 50%; 
            background-color: #444;
            color: white;
            border: none;
            box-shadow: 0 4px #222; 
            transition: all 0.1s;
        }

        .control-btn:active {
            box-shadow: 0 0 #222;
            transform: translateY(4px); 
        }

        .horizontal-controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        #start-button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="info-panel">
            <h2>Score: <span id="score">0</span></h2>
            <div id="next-piece-container">
                <h4>Next:</h4>
                <div id="next-piece"></div>
            </div>
            <button id="start-button">Start Game</button>
        </div>
        <div id="game-board"></div>
    </div>

    <div id="controls">
        <button id="rotate-btn" class="control-btn">ğŸ”„</button>
        <div class="horizontal-controls">
            <button id="left-btn" class="control-btn">â—€</button>
            <button id="right-btn" class="control-btn">â–¶</button>
        </div>
        <button id="down-btn" class="control-btn">â¬‡</button>
    </div>

    <script>
        // --- 1. ì´ˆê¸° ì„¤ì • ë° ë³€ìˆ˜ ---

        const board = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score');
        const startButton = document.getElementById('start-button');

        const width = 10; // ë³´ë“œ ë„ˆë¹„ (10ì¹¸)
        const height = 20; // ë³´ë“œ ë†’ì´ (20ì¹¸)
        let score = 0;
        let cells = []; // ë³´ë“œ ì…€(ì¹¸) ìš”ì†Œë¥¼ ì €ì¥í•  ë°°ì—´
        let currentPosition = 4; // í˜„ì¬ ë¸”ë¡ì˜ ì‹œì‘ ìœ„ì¹˜
        let timerId = null; // ê²Œì„ ë£¨í”„ íƒ€ì´ë¨¸ ID
        let nextRandom = 0; // ë‹¤ìŒ ë¸”ë¡ ì¸ë±ìŠ¤

        // ğŸ“ í…ŒíŠ¸ë¡œë¯¸ë…¸ ëª¨ì–‘ ì •ì˜ (ê° ì¹¸ì˜ ìƒëŒ€ì  ìœ„ì¹˜)
        // [i, width*i + j] í˜•íƒœë¡œ ì •ì˜í•©ë‹ˆë‹¤. (i:íšŒì „, j:ë¸”ë¡ì˜ ìœ„ì¹˜)
        const lTetromino = [
            [1, width + 1, width * 2 + 1, 2],
            [width, width + 1, width + 2, width * 2 + 2],
            [1, width + 1, width * 2 + 1, width * 2],
            [width, width * 2, width * 2 + 1, width * 2 + 2]
        ];
        const iTetromino = [
            [1, width + 1, width * 2 + 1, width * 3 + 1],
            [width, width + 1, width + 2, width + 3],
            [1, width + 1, width * 2 + 1, width * 3 + 1],
            [width, width + 1, width + 2, width + 3]
        ];
        const oTetromino = [
            [0, 1, width, width + 1],
            [0, 1, width, width + 1],
            [0, 1, width, width + 1],
            [0, 1, width, width + 1]
        ];

        // ëª¨ë“  í…ŒíŠ¸ë¡œë¯¸ë…¸ ë°°ì—´: [ëª¨ì–‘ ë°°ì—´, CSS í´ë˜ìŠ¤ ì´ë¦„]
        const theTetrominoes = [
            [lTetromino, 'L'],
            [iTetromino, 'I'],
            [oTetromino, 'O']
            // Z, S, T, J ë¸”ë¡ë„ ì¶”ê°€í•˜ì—¬ì•¼ ì™„ë²½í•©ë‹ˆë‹¤. (ê³µê°„ ê´€ê³„ìƒ ìƒëµ)
        ];

        let random = Math.floor(Math.random() * theTetrominoes.length);
        let currentRotation = 0;
        let currentTetromino = theTetrominoes[random]; 
        let current = currentTetromino[0][currentRotation]; // í˜„ì¬ íšŒì „ ëª¨ì–‘

        // --- 2. ë³´ë“œ ìƒì„± ---

        function createBoard() {
            for (let i = 0; i < width * height; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                board.appendChild(cell);
                cells.push(cell);
            }
        }

        // --- 3. ë¸”ë¡ ê·¸ë¦¬ê¸° ë° ì§€ìš°ê¸° í•¨ìˆ˜ ---

        function draw() {
            current.forEach(index => {
                if (cells[currentPosition + index]) {
                     cells[currentPosition + index].classList.add('tetromino', currentTetromino[1]);
                }
            });
        }

        function undraw() {
            current.forEach(index => {
                if (cells[currentPosition + index]) {
                    cells[currentPosition + index].classList.remove('tetromino', currentTetromino[1]);
                }
            });
        }

        // --- 4. ì´ë™ ë° ì¶©ëŒ ê°ì§€ ë¡œì§ ---

        function moveDown() {
            undraw();
            
            // ë°”ë‹¥ ë˜ëŠ” ë‹¤ë¥¸ ë¸”ë¡ì— ë‹¿ëŠ”ì§€ ê²€ì‚¬
            const isCollision = current.some(index => 
                (currentPosition + index + width) >= (width * height) || // ë°”ë‹¥ ì²´í¬
                cells[currentPosition + index + width].classList.contains('taken') // ê³ ì •ëœ ë¸”ë¡ ì²´í¬
            );

            if (isCollision) {
                freeze();
                return;
            }
            
            currentPosition += width;
            draw();
        }

        function freeze() {
            // í˜„ì¬ ë¸”ë¡ì„ ê³ ì • (taken í´ë˜ìŠ¤ ì¶”ê°€)
            current.forEach(index => cells[currentPosition + index].classList.add('taken')); 
            
            addScore(); 

            // ê²Œì„ ì˜¤ë²„ ì²´í¬: ìƒˆ ë¸”ë¡ì´ ì‹œì‘í•˜ìë§ˆì ê²¹ì¹˜ë©´ ì¢…ë£Œ
            if (current.some(index => cells[currentPosition + index].classList.contains('taken') && index < 4)) {
                clearInterval(timerId);
                timerId = null;
                scoreDisplay.innerHTML = 'Game Over! Score: ' + score;
                startButton.innerText = 'Restart';
                return;
            }

            // ìƒˆ ë¸”ë¡ ìƒì„± ë° ì„¤ì •
            random = nextRandom; 
            nextRandom = Math.floor(Math.random() * theTetrominoes.length);

            currentTetromino = theTetrominoes[random];
            current = currentTetromino[0][0]; // 0ë„ íšŒì „ ìƒíƒœë¡œ ì‹œì‘
            currentPosition = 4;
            currentRotation = 0;
            
            draw();
        }

        function moveLeft() {
            undraw();
            // ì¶©ëŒ ì¡°ê±´ ê²€ì‚¬
            const isAtLeftEdge = current.some(index => (currentPosition + index) % width === 0);
            const isTaken = current.some(index => cells[currentPosition + index - 1].classList.contains('taken'));

            if (!isAtLeftEdge && !isTaken) {
                currentPosition -= 1;
            }
            draw();
        }

        function moveRight() {
            undraw();
            // ì¶©ëŒ ì¡°ê±´ ê²€ì‚¬
            const isAtRightEdge = current.some(index => (currentPosition + index) % width === width - 1);
            const isTaken = current.some(index => cells[currentPosition + index + 1].classList.contains('taken'));

            if (!isAtRightEdge && !isTaken) {
                currentPosition += 1;
            }
            draw();
        }

        function rotate() {
            undraw();
            
            // ë‹¤ìŒ íšŒì „ ìƒíƒœ ê³„ì‚°
            let tempRotation = currentRotation + 1;
            if (tempRotation === currentTetromino[0].length) {
                tempRotation = 0;
            }
            const nextRotation = currentTetromino[0][tempRotation];

            // ë²½ ì¶©ëŒ ì²´í¬ (ê°„ë‹¨í™”ëœ ì²´í¬)
            const isAtEdge = nextRotation.some(index => (currentPosition + index) % width === 0 || (currentPosition + index) % width === width - 1);
            
            // íšŒì „ í›„ 'taken' ë¸”ë¡ê³¼ì˜ ì¶©ëŒ ì²´í¬
            const isOverlap = nextRotation.some(index => cells[currentPosition + index].classList.contains('taken'));

            if (!isAtEdge && !isOverlap) {
                currentRotation = tempRotation;
                current = nextRotation;
            } 
            // ì°¸ê³ : ì‹¤ì œ í…ŒíŠ¸ë¦¬ìŠ¤ëŠ” 'Wall Kick' ë¡œì§ì´ ìˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœ íšŒì „ìœ¼ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

            draw();
        }

        // --- 5. ì ìˆ˜ ë° ì¤„ ì œê±° ë¡œì§ ---

        function addScore() {
            for (let i = 0; i < width * height; i += width) {
                const row = Array.from({length: width}, (_, k) => i + k);

                // í•œ ì¤„ì´ ëª¨ë‘ 'taken' í´ë˜ìŠ¤ë¥¼ ê°€ì¡ŒëŠ”ì§€ í™•ì¸
                if (row.every(index => cells[index].classList.contains('taken'))) {
                    score += 10;
                    scoreDisplay.innerHTML = score;
                    
                    // í•´ë‹¹ ì¤„ ì œê±°
                    row.forEach(index => {
                        cells[index].classList.remove('taken', 'tetromino', currentTetromino[1]); 
                    });

                    // ìœ— ì¤„ì„ ëŒì–´ ë‚´ë¦¼
                    const cellsRemoved = cells.splice(i, width); // ì œê±°ëœ ì¤„ (10ê°œ)
                    cells = cellsRemoved.concat(cells); // ì œê±°ëœ ì¤„ì„ ë§¨ ì•ìœ¼ë¡œ(ìœ„ë¡œ) ë¹ˆ ì¤„ë¡œ ì±„ì›€

                    // DOM ì—…ë°ì´íŠ¸
                    cells.forEach(cell => board.appendChild(cell));
                }
            }
        }

        // --- 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ê²Œì„ ì‹œì‘ ---

        createBoard();

        // ğŸ’¡ ëª¨ë°”ì¼ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        document.getElementById('left-btn').addEventListener('click', moveLeft);
        document.getElementById('right-btn').addEventListener('click', moveRight);
        document.getElementById('rotate-btn').addEventListener('click', rotate);
        document.getElementById('down-btn').addEventListener('click', () => { 
            moveDown(); // í•˜ë“œ ë“œë¡­ì´ ì•„ë‹Œ, í•œ ì¹¸ ì¦‰ì‹œ ë‚´ë¦¬ê¸°
        });

        // ê²Œì„ ì‹œì‘/ì¼ì‹œì •ì§€
        startButton.addEventListener('click', () => {
            if (timerId) {
                // ê²Œì„ ë©ˆì¶¤ (Pause)
                clearInterval(timerId);
                timerId = null;
                startButton.innerText = 'Continue Game';
            } else {
                // ê²Œì„ ì‹œì‘: 0.8ì´ˆë§ˆë‹¤ moveDown ì‹¤í–‰
                timerId = setInterval(moveDown, 800); 
                startButton.innerText = 'Pause Game';
                draw();
            }
        });

        // ì‹œì‘ ì‹œ ì²« ë¸”ë¡ ê·¸ë¦¬ê¸° ì¤€ë¹„
        nextRandom = Math.floor(Math.random() * theTetrominoes.length);
        draw(); 
    </script>
</body>
</html>
